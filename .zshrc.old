# ============================================================================
# ZSH Configuration - Minimal Setup with Starship
# ============================================================================

# History
HISTFILE=~/.histfile
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt SHARE_HISTORY

# Key bindings (emacs mode)
bindkey -e

# ============================================================================
# Completion System
# ============================================================================
autoload -Uz compinit
compinit

zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

# ============================================================================
# PATH Configuration
# ============================================================================
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

# Homebrew
eval "$(/opt/homebrew/bin/brew shellenv)"

# Go
export PATH="$HOME/dist/go/bin:$PATH"
export PATH="$(go env GOPATH)/bin:$PATH"
export GO111MODULE=on

# Ruby (rbenv)
export PATH="$HOME/.rbenv/bin:$PATH"
export PATH="/opt/homebrew/opt/ruby/bin:$PATH"
eval "$(rbenv init -)"

# Rust/Cargo
export PATH="$HOME/.cargo/bin:$PATH"
[ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"

# Kubernetes (krew)
export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"

# Node (nvm)
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/usr/local/opt/nvm/nvm.sh" ] && . "/usr/local/opt/nvm/nvm.sh"

# pnpm
export PNPM_HOME="$HOME/Library/pnpm"
[[ ":$PATH:" != *":$PNPM_HOME:"* ]] && export PATH="$PNPM_HOME:$PATH"

# Local/custom overrides (last to take priority)
export PATH="$HOME/.local/bin:$PATH"
export PATH="$HOME/overrides/bin:$PATH"

# ============================================================================
# SSH Agent
# ============================================================================
# Option 1: 1Password SSH Agent (uncomment if using 1Password for SSH keys)
# export SSH_AUTH_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"

# Option 2: macOS native SSH agent (default)
# Keys persist via Keychain. Add keys with: ssh-add --apple-use-keychain ~/.ssh/id_ed25519
# To auto-load keys, add to ~/.ssh/config:
#   Host *
#     AddKeysToAgent yes
#     UseKeychain yes

# ============================================================================
# GPG Agent
# ============================================================================
export GPG_TTY=$(tty)
# Start gpg-agent if not running
if ! pgrep -x "gpg-agent" > /dev/null; then
  gpgconf --launch gpg-agent 2>/dev/null
fi

# ============================================================================
# Environment
# ============================================================================
export EDITOR='nvim'
export LC_ALL="en_GB.UTF-8"
export LC_CTYPE="en_GB.UTF-8"
export LANG="en_GB.UTF-8"

# ============================================================================
# Aliases
# ============================================================================
# Editor
alias vi="nvim"
alias vim="nvim"

# Quick config access
alias zshrc="$EDITOR ~/.zshrc"
alias vimrc="$EDITOR ~/.vimrc"
alias reload=". ~/.zshrc"

# Git
alias glo="git log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit --date=relative"

# Kubernetes
alias k="kubectl"
alias kctl="kubectl"

# Docker
alias dm="docker-machine"

# Ruby/Bundler
alias b="bundle"
alias bi="bundle install"
alias be="bundle exec"

# Timoni
alias tim="timoni"

# Search (ack alternatives - consider using ripgrep 'rg' instead)
alias gack="ack --ignore-dir vendor"

# ============================================================================
# Functions
# ============================================================================
# Create git branch with prefix
function gmb() {
  git checkout -b "gm/$1"
}

# Fuzzy checkout git branch
function gcz() {
  git checkout $(git branch | fzf | tr -d '[:space:]')
}

# cd to git root
function cdr() {
  cd "$(git rev-parse --show-toplevel)"
}

# Unescape strings
function unescape() {
  echo "$1" | sed 's/\\t/    /g' | sed 's/\\n/\n/g' | sed 's/\\//g'
}

# ============================================================================
# Tool Integrations
# ============================================================================
# fzf
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# Google Cloud SDK
[ -f "$HOME/google-cloud-sdk/path.zsh.inc" ] && . "$HOME/google-cloud-sdk/path.zsh.inc"
[ -f "$HOME/google-cloud-sdk/completion.zsh.inc" ] && . "$HOME/google-cloud-sdk/completion.zsh.inc"

# Completions for CLI tools
command -v flux >/dev/null && . <(flux completion zsh)
command -v cue >/dev/null && . <(cue completion zsh)
command -v kubectl >/dev/null && . <(kubectl completion zsh)

# Base16 Shell (colors)
BASE16_SHELL="$HOME/.config/base16-shell/"
[ -n "$PS1" ] && [ -s "$BASE16_SHELL/profile_helper.sh" ] && \
  eval "$("$BASE16_SHELL/profile_helper.sh")"

# ============================================================================
# Starship Prompt (must be at end)
# ============================================================================
eval "$(starship init zsh)"
